---
output:
  html_document:
    theme: ce
    highlight: pygments

---
<br />

Este exercício é uma aplicação canônica de conceitos da inferência Bayesiana. Supomos uma pesquisa das cintenções de voto para um determinado candidato à prefeito da nossa Capital.

Na inferência Bayesiana buscamos conhecer a distribuição de probabilidade dos nossos parâmetros de interesse, a qual é produto da distribuição à priori com a verossimilhança dos dados, conforme:

$$
\begin{align}
  [\theta | y] \sim [ y | \theta ] . [ \theta ]
\end{align}
$$
, onde: <br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$\theta$ é parâmetro de interesse (ou vetor de parâmetros)<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$y$ são os dados<br />
    
Vamos começar definindo nossa priori. Depois vamos analisar a verossimilhança dos dados de uma amostra deste tipo de dado e, então, construir nossa posteriori.
<br />
<hr />

### Definição da priori

A priori será uma distribuição Beta por atender aos requisitos da variável: contónua com domínio $[0,1]$.
$$
\begin{equation}
  [\theta] \sim \frac{ \Gamma(\alpha) \Gamma(\beta) }{\Gamma(\alpha+\beta)} \theta^{\alpha-1} (1-\theta)^{\beta-1}
\end{equation}
$$

Por subjetividade, escolho que minha priori terá moda $0.525$ e que $95%$ da distribuição está entre os valores de $0.40$ e $0.65$. Utilizando as funções da dsitribuição Beta, vamos encontrar os parâmetros que dão essa forma à função.
<br />

```{r, echo=FALSE, message=FALSE}
## General settings
require(ggplot2)
```
```{r}
## Definition
mode <- 0.525
l.inf <- 0.4
l.sup <- 0.65

## Tryals
alpha <- seq(1, 50, length.out = 1e5)
beta <- ( (1-mode)*alpha + 2*mode - 1 ) / (mode)
p <- pbeta( l.sup, shape1 = alpha, shape2 = beta) - pbeta( l.inf, shape1 = alpha, shape2 = beta)
err <- abs(0.95-p)

## Best estimate
alpha <- alpha[which( err == min(err) )]
beta <- beta[which( err == min(err) )]
## Check it out
# pbeta(0.525, shape1 = alpha, shape2 = beta)
# pbeta( l.inf, shape1 = alpha, shape2 = beta)
# pbeta( l.sup, shape1 = alpha, shape2 = beta)

```

<br />
Com estes parâmetros, nossa priori tem a forma:
$$
\begin{equation}
  [\theta] \sim Beta(\theta, \alpha=`r formatC( alpha, digits=2, format="f" )`, \beta=`r formatC( beta, digits=2, format="f" )`)
\end{equation}
$$

<br />
```{r, echo=FALSE, fig.width=4, fig.height=3, fig.align='center'}
## Plot it
col.priori <- "cornflowerblue"
txt.mode <- paste("Moda:", mode)

ggplot( data.frame(x=seq( 0, 1, l=1e3 ) ), aes(x) ) + 
  stat_function( fun=function(x){ dbeta(x, alpha, beta) }, colour = col.priori ) +
  scale_colour_brewer( palette = 1) +
  scale_x_continuous(name = "Intenções de voto" ) +
  scale_y_continuous(name = element_blank() ) +
  theme(plot.title = element_text( lineheight=1, face="bold", size = 12 )
        , panel.background = element_rect(colour = "gray75") ) +
  annotate("segment", x = mode, xend = mode
           , y = 0
           , yend = dbeta(mode, alpha, beta)*1.05
           , alpha = 0.5) +
  annotate("text", label = txt.mode , x = mode*1.01, y = 6.2, hjust = 0, vjust = 0, size = 3 )

```
<br />
<hr />

### Verossimilhança

```{r, data, echo=FALSE}
n <- 30
k <- sample(1:30, size = 1)
```
Nossos dados fictícios constituem-se de uma amostra (suponha aleatória simples) de $n$ indivíduos cuja resposta é se tem ou não tem a insteção de votar no atual prefeito na eleição que ocorrerá este ano, caso ele seja candidato.

Logo, a distribuição dos nosso dados é uma Binomia:
$$
\begin{align}
  y \sim Bin( \theta; n, k ) \\
\end{align}
$$
, onde:
$$
\begin{align}
  Bin( \theta; n, k ) = \binom{n}{k} \theta^{k} (1-\theta)^{n-k} \\
\end{align}
$$

Vamos considerar $n=`r n `$ e que destes $k=`r k `$ disseram que votariam no candidato:
$$
\begin{align}
  Bin( \theta; `r n `, `r k ` ) = \binom{`r n `}{`r k `} \theta^{`r k `} (1-\theta)^{`r n-k `} \\
\end{align}
$$

```{r, echo=FALSE, fig.width=4, fig.height=3, fig.align='center'}
## Plot it
col.lik <- "chartreuse4"

x <- seq( 0, n )
df <- data.frame(x, y = dbinom(x , size = n, prob = (k/n) ) )

ggplot( df, aes( x=x, y=y ) ) + 
  geom_line( colour = col.lik ) +
  scale_colour_brewer( palette = 1) +
  scale_x_continuous(name = "k" ) +
  scale_y_continuous(name = element_blank() ) +
  theme(plot.title = element_text( lineheight=1, face="bold", size = 12 )
        , panel.background = element_rect(colour = "gray75") )

```
<br />
<hr />


### Posteriori

O caso do nosso exemplo é de uma priori conjugada, cuja posteriori será uma atualização da priori pela verossimilhança. Provamos isso analisando as distribuições acima:

$$
\begin{equation}
  [\theta | y] \sim \binom{n}{k} \theta^{k} (1-\theta)^{n-k} ~ . ~ \frac{ \Gamma(\alpha) \Gamma(\beta) }{\Gamma(\alpha+\beta)} \theta^{\alpha-1} (1-\theta)^{\beta-1}
\end{equation}
$$
<br />

A combinação $\binom{n}{k}$ e a fração de funções Gamma não dependem de $\theta$. Podemos, portanto tornar a equação acima proporcional:
$$
\begin{equation}
  [\theta | y] \propto \theta^{k} (1-\theta)^{n-k} ~ . ~ \theta^{\alpha-1} (1-\theta)^{\beta-1}
\end{equation}
$$

E agrupando os termos comuns:
$$
\begin{equation}
  [\theta | y] \propto \theta^{k+\alpha-1} (1-\theta)^{n-k+\beta-1}
\end{equation}
$$

Agora vemos que podemos reescrever os expoentes e chegar à parte da distribuição Beta dependente de *theta* novamente:
$$
\begin{equation}
  [\theta | y] \propto \theta^{(\alpha+k)-1} (1-\theta)^{(\beta+n-k)-1}
\end{equation}
$$

A qual pode, então ser reescrita como:
$$
\begin{equation}
  [\theta | y] \propto Beta(\theta; \alpha^{*}, \beta^{*})
\end{equation}
$$
, onde:
$$
\begin{align}
  \alpha^{*} & = \alpha + k \\
  \beta^{*} & = \beta + (n-k) \\
\end{align}
$$

Repare, ainda que o $\alpha$ é atualizado pelo número de sucessos em nossa amostra, quanto o $\beta$, o é pelo número de fracassos.

Assim, teremos:
```{r, posteriori-params, echo=FALSE}
alpha.star = alpha + k
beta.star = beta + (n-k)
mode.post <- ( alpha.star - 1 )/( beta.star + alpha.star - 2)
```
$$
\begin{align}
  \alpha^{*} & = `r formatC( alpha.star, digits = 2, format = "f") ` \\
  \beta^{*} & = `r formatC( beta.star, digits = 2, format = "f") ` \\
\end{align}
$$

E nosa posteriori será:
$$
\begin{equation}
  [\theta] \sim Beta(\theta; \alpha=`r formatC(alpha.star, digits=2, format="f")`, \beta=`r formatC(beta.star, digits=2, format="f")`)
\end{equation}
$$

```{r, echo=FALSE, fig.width=6, fig.align='center'}
## Plot it
col.posteriori <- "red3"
txt.mode.prio <- paste("Moda priori:", formatC(mode, digits = 2, format = "f" ) )
txt.mode.post <- paste("Moda posteriori:", formatC(mode.post, digits = 2, format = "f" ) )

ggplot( data.frame(x=seq( 0, 1, l=1e3 ) ), aes(x) ) + 
  stat_function( fun=function(x){ dbeta(x, alpha, beta) }, colour = col.priori ) +
  stat_function( fun=function(x){ dbeta(x, alpha.star, beta.star) }, colour = col.posteriori ) +
  scale_colour_brewer( palette = 1) +
  scale_x_continuous(name = "Intenções de voto" ) +
  scale_y_continuous(name = element_blank() ) + 
  theme(plot.title = element_text( lineheight=1, face="bold", size = 12 )
        , panel.background = element_rect(colour = "gray75") ) +
  annotate("segment"
           , x = mode.post, xend = mode.post
           , y = dbeta(mode.post, alpha.star, beta.star)*0.95
           , yend = dbeta(mode.post, alpha.star, beta.star)*1.05
           , alpha = 0.45 ) +
  annotate("text", label = txt.mode.post , x = mode.post*1.01
           , y = dbeta(mode.post, alpha.star, beta.star)
           , hjust = 0, vjust = 0, size = 3 ) +
  annotate("segment", x = mode, xend = mode
           , y = dbeta(mode, alpha, beta)*0.95
           , yend = dbeta(mode, alpha, beta)*1.05
           , alpha = 0.45 ) +
  annotate("text", label = txt.mode.prio , x = mode*1.01
           , y = dbeta(mode, alpha, beta)
           , hjust = 0, vjust = 0, size = 3 )

```
<br />
<br />

<br />
<br />
<br />
<br />